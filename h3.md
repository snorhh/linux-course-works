## Linux-palvelimet, syksy 2024. Tehtävä h3: Hello Web Server

### x) Tiivistelmä tekstistä "Name-based Virtual Host Support", Apache documentation https://httpd.apache.org/docs/2.4/vhosts/name-based.html

- IP:hen perustuvassa virtuaalipalvelimessa jokaisella hostilla täytyy olla oma IP-osoite.
- Sen sijaan nimipohjaisten virtuaalisten palvelinten avulla voidaan yhdellä IP-osoitteella hostata useaa eri palvelinta.
- DNS-palvelin mappaa host-nimet oikeaan IP-osoitteeseen ja Apachen HTTP-palvelin konfiguroidaan tunnistamaan host-nimet.
- Asetuksissa määritellään <VirtualHost>-blokkien sisään vähintäänkin palvelimen nimi (ServerName), mahdolliset aliakset (ServerAlias) ja kansio, jossa kyseisen hostin sisältö löytyy (DocumentRoot).
- Server-aliaksilla voidaan ohjata liikenne vähän erilaisilla osoitteilla samaan palvelimeen, esimerkiksi hs.fi ja www.hs.fi tai firmannimi.com ja firmannimi.org.

### **Tiivistelmä tekstistä Name Based Virtual Hosts on Apache – Multiple Websites to Single IP Address, Tero Karvinen, 10.4.2018, https://terokarvinen.com/2018/04/10/name-based-virtual-hosts-on-apache-multiple-websites-to-single-ip-address/
Lyhyt ohje nimipohjaisen palvelimen asentamiseksi ja testaamiseksi.

- Asenna palvelin (sudo -apt-get -y install apache2)
- Lisää virtuaalipalvelin lisäämällä konfiguraatiotiedosto, jossa palvelimen tiedot <VirtualHost>-blokin sisällä
- Ota konfiguraatio käyttöön (restart a2ensite 'konfiguraatiotiedosto') ja uudelleenkäynnistä palvelin (sudo systemctl restart apache2)
- Luo nettisivu normaalina käyttäjänä ja testaa se curl-komennolla (curl -H 'Host: esimerkki.com' localhost'
- Simuloi nimipalvelinta muokkaamalla -hosts-tiedostoa ja lisää sinne esimerkiksi 127.0.0.1. localhost ja 127.0.0.1. "esimerkki.com, ja nyt voit kokeilla osoitetta http://localhost selaimella. Jos näet eri sivut, olet onnistuneesti asentanut kaksi virtuaalipalvelinta.

## a) Apache-palvelimen asesnnus ja testaus, että webbipalvelin vastaa localhost-osoitteesta
Avasin Linuxin virtuaalikoneessa, kirjauduin sisään, avasin Terminal emulator -ohjelman ja tein päivityksen *sudo apt-get update* -komennolla.

Olin asentanut Apache2-palvelminen luennolla *sudo apt-get install apache2* -komennolla.
Kokeilin mitä tapahtuu, jos kirjoitan "localhost" selaimen osoiteriville. Ruudulle ilmestyi Apachen Debian oletussivu. Ilmeisesti siis palvelin pyöri. Tässä vaiheessa en ollut tehnyt mitään muutoksia palvelimen asetuksiin.
 
 ![Add file: Upload](localhost_asennus.jpg)

 Kokeilin hakea localhostin myös komentorivillä curl-komennolla. Ilman mitään paramatrejä curl-hakee sivun sisällön ja printtaa sen komentokehotteeseen. (Lähde: https://www.baeldung.com/linux/curl-guide)

  ![Add file: Upload](curl_localhost_on.jpg) 
  *curl localhost | less * -komento printtasi ensimmäisen sivun Apache2-oletussivun html-dokumentista ruudulle.

  Apache2-palvelinta hallinnoidaan systemctl-komennolla, joten kokeilin sulkea palvelimen ja kokeilla uudelleen localhostia. (Muita Apache- tai järjestelmäversioita saatetaan hallinnoida muunlaisilla komennoilla.) Lähde: https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-debian-11.

  *sudo systemctl stop apache2*
    ![Add file: Upload](stoprestart_localhost.jpg) 

Kun palvelin oli pysäytetty, localhostia ei löytynyt, ja uudelleenkäynnistyksen jälkeen curl-komento tulosti sen html-sisällön taas ruudulle.

Kokeillessani palvelimen pysäyttämistä ja uudelleenkäynnistämistä huomasin, että jos laitoin systemctl-komennon ilman sudoa, sain eteeni popup-ikkunan, johon minun tuli laittaa salasana, mutta jos aloitin komennon "sudo systemctl", niin minun ei tarvinnut laittaa salasanaa ollenkaan. Pikainen kysymys ChatGTP:ltä ja sen jälkeinen nettihaku kertoivat, että järjestelmä muistaa salasanan jonkin aikaa, asetuksista riippuen esim. 5-15 minuuttia, ettei sitä tarvitse laittaa jokaisen sudo-komennon jälkeen, jos niitä tekee useita pienen ajan sisällä.

## b) Lokimerkinnät sivun lataamisesta

Lueskelin tiedostoa /etc/apache2/apache2.conf, ja opin siitä, että systemctl-komennonn sijaan Debianissa voi käyttää komentoa apache2ctl, esim. apache2ctl stop ja apache2ctl start. Nuo komennot eivät kuitenkaan vaikuttaneet toimivan. Ehkä ne eivät toimikaan tässä kyseisessä versiossa.

Hain taas html-sivun localhostista, ja katsoin sitten komennolla "sudo tail /var/log/apache2/access.log" kymmenen viimeistä merkintää kyseistä lokista. (Tail-komennosta: https://www.howtogeek.com/481766/how-to-use-the-tail-command-on-linux/) Toistin webbisivun haun ja katsoin uudelleen lokiin, ja näin että lokiin oli tullut uusi merkintä.

 ![Add file: Upload](accesslog_localhost.jpg) 

 Access-lokissa näkyy useita kokeiluja curl-toiminnon käytöstä.

 Yritin mennä /var/log/apache2-kansioon katsomaan mitä siitä löytyy, mutta en päässyt. ChatGPT neuvoi käyttämään komentoa "sudo su", jolloin käyttäjänimeni muuttui "rootiksi". Root-käyttäjällä pääsin apache2-lokikansioon, ja näin että siellä on lokit access.log, error.log ja otherv_hosts_access.log. "Exit"-komennolla pääsin takaisin omaan käyttäjänimeeni. Sudo su -komennosta on lisää tietoa sivulla https://linuxize.com/post/su-command-in-linux/, mutta en jaksanut siihen kummemmin paneutua. Ihmettelin vain, miksi en päässyt tiettyyn kansioon, vaikka minulla on sudo-oikeudet.

Lokin tulkitsemisessa käytetty lähteenä https://httpd.apache.org/docs/current/logs.html ja muut lähteet mainittu erikseen.

127.0.0.1 : Tämä on pyynnön tehneen koneen IP-osoite, eli tässä tapauksessa kotiverkkoni sisäinen osoite ja sama osoite, jossa apache2-palvelin pyörii.

- : Ensimmäinen viiva (hyphen) viittaa asiakaskoneen (client) RFC 1413 -identiteettiin, jota siis tässä lokissa ei tiedetä. Apachen dokumentaation mukaan tämä tieto on hyvin epäluotettava, eikä se ole oletuksena käytössä. Lisätietoa RFC 1413 identiteetistä: https://datatracker.ietf.org/doc/html/rfc1413.

Apache2.conf-tiedostosta löytyy lokin formaatti. Tiedostoa voi lukea sivu kerrallaan esimerkiksi komennolla "sudo cat /etc/apache2/apache2.conf | less"

Aikaformaatti päivä/kuukausi/vuosi:hh:mm:ss ja lopuksi aikavyöhyke UTC:hen verrattuna.

"GET / HTTP/1.1" : asiakaskone teki GET-pyynnön palvelimelle ja käytti HTTP 1.1 -protokollaa. On olemassa myös uudemmat HTTP 2 ja HTTP 3 -protokollat (sekä vanhempi 1.0). Lähde: https://http.dev/1.1

- 200: Numerokoodi, joka kertoo pyynnön onnistumisesta. Kakkosella alkavat ovat onnistuneita, kolmosella alkavat ohjauksia eteenpäin ja nelosella alkavat virheilmoituksia palvelimelta.

-  10956: Haetun sisällön koko (ilmeisesti tavuina?)

-  "-" Tässä kohdassa on referer eli se sivu, jossa pyynnön tekijä oli kun lähetti pyynnön palvelimelle. Koska tässä tapauksessa tein curl-komennon komentoriviltä, enkä klikkailut mitään linkkejä selaimessa, on tämä kohta tyhjä.

- "curl/7.8.8.1" Tässä kohtaa on se tieto, jonka selain lähettää palvelimelle itsestään eli user-agent header. Koska kyseessä ei ollut selaimella tehty pyyntö vaan curl-komento, niin pyysin ChatGPT:tä selittämään mitä tässä kohtaa näkyy. ChatGPT kertoi, että curl-komento lähettää mainitun tiedon itsestään, mutta että sitä voi itse myös muuttaa. Kokeilinkin ChatGPT:n neuvomalla komennolla "curl -A "MyCustomUserAgent/1.0" localhost, eli lähetin palvelimelle  taas pyynnön hakea nettisivu, ja sen jälkeen katsoin access.log-tiedostoon, jossa näkyi kyseinen merkintä. 

![Add file: Upload](customagent.jpg) 


Komennolla "sudo cat /etc/apache2/sites-available/*.conf | less " katsoin virtuaalipalvelimen konfiguraatiota, jossa luki CustomLog "Combined"

Tarkastelin sitten myös toista lokia eli virhelokia komennolla "sudo tail /var/log/apache2/error.log". TODO siellä ei näkynyt mitään

## c) Etusivu uusiksi. Uuden virtuaalipalvelimen teko.
Lähde (ohjesivu): https://terokarvinen.com/2018/04/10/name-based-virtual-hosts-on-apache-multiple-websites-to-single-ip-address/ muut lähteet mainittu erikseen.

Ohjesivun mukaisesti suoritin komennon $ echo "Default"|sudo tee /var/www/html/index.html

Tee-komento lisää echo "Default" -komennon tuloksen kyseiseen tiedostoon eli index.html-sivuun. (Lisäksi se tulostuu komentorivi-ikkunaan normaalisti echo-komennon mukaisesti.) Lähde: https://linuxconfig.org/tee

Tämän jälkeen tein komennon "curl localhost", ja aikaisemman apache2-oletussivun sijaan näin tekstin "Default".  
![Add file: Upload](curldefault.jpg) 

Tarkistin myös selaimella, että siellä näkyy sama:
![Add file: Upload](mozillaefault.jpg)

Kävin vielä katsomassa var/www/html-kansiossa, että siellä kyseinen index.html-tiedosto on ja sen sisältö tosiaan on pelkkä "Default"

![Add file: Upload](varhtml.jpg) 

Vaihdoin sudo su -komennolla root-käyttäjäksi, jotta pääsin apache2-kansioon ja siellä sites-available-alikansioon. Kansiossa oli kaksi tiedostoa: 000-default.conf ja default-ssl.conf. 000-default.conf on Apachen oletussivun virtuaalipalvelin-tiedot.

Tiedostossa on pelkästään ServerAdmin, DocumentRoot ja lokien sijaintitiedot.
![Add file: Upload](defaultvhost.jpg) 

default-ssl.conf-tiedostoa lukemalla ja vähän googlaamalla ymmärsin, että SSL liittyy sertifikaatteihin (Secure Sockets Layer), joiden avulla sivusto voi todistaa jonkin kolmannen osapuolen avulla, että yhteys on turvallinen (esim. pankit).

En täysin ymmärrä, mitä tehtävässä pitää tehdä, joten hyppäsin kohtaan, jossa tehdään sivu "hattu.example.com". Sivun nimen tulee näkyä asetustiedoston nimessä ja ServerName-muttuujassa sekä etusivun sisällössä. Sille pitää siis tehdä uusi virtual host. Koska en pääse apache2-kansioon suoraan, niin käytän sudo-oikeuksia muokatakseni/luodakseni sinne tiedoston hattu.example.com.conf": sudoedit /etc/apache2/sites-available/hattu.example.com.conf"

![Add file: Upload](sudovirtualhost.jpg) 

Sen jälkeen enabloin virtuaalipalvelimen komennolla *sudo a2ensite hattu.example.com* ja uudelleenkäynnistin palvelimen komennolla *sudo systemctl restart apache2* Tai itse asiassa käytiin komentoa *systemctl reload apache2*, koska komentokehote niin kehotti tekemään.

Sitten loin hattu.example.com-hakemiston komennolla *mkdir -p /var/www/publicsites/hattu.example.com/ ja kirjoitin index.html-sivulle tekstin "hattu" komennolla echo pyora > /var/www/publicsites/hattu.example.com/index.html

![Add file: Upload](mkdirp.jpg) 
-p tekee tarvittavat yläkansiot, jos niitä ei vielä ollut olemassa. Jouduin käyttämään sudo-oikeuksia kansion luomisessa, ja tässä vaiheessa muistin, että kyseinen kohta piti tehdä tavallisena käyttäjänä. Niinpä poitin juuri tekemäni kansion (sudo rmdir...) Kävin katsomassa, että www-kansiossa ei ollut enää publicsites-kansiota, mutta tietenkin se oli, koska olin vain poistanut sen sisältämän alikansion, joten poistin sitten myös publicsites-kansion.

Tässä vaiheessa olin jo niin pyörällä päästäni, että etsin netistä vanhan raportin, ja katsoin sieltä apua. Tehtävä ei ollut ihan samanlainen, mutta siinä mainittiin komento "sudo a2enmod userdir", jonka olin myös luennolla kirjoittanut muistiin. Suoritin siis sen ja sen jälkeen "systemctl restart apache2". 

Kysyin ChatGPT:ltä miten saan apachen unohtamaan sudo-oikeuteni, ja se neuvoi käyttämään komentoa "sudo -k", joten niin tein. Sen jälkeen kirjoitin "mkdir -p /var/www/publicsites/hattu.example.com/

------------------- uusix män

Päätin ottaa koko tehtävän uusiksi, koska muuten vain hakkaan päätäni seinään ja toivon, että jokin menee sattumalta oikein.

Eli, tehtävänä on tehdä uusi "name based virtual host" ja sivun tulee näkyä suoraan palvelimen etusivulla http://localhost". Sivua pitää myös pystyä muokkaamaan normaalina käyttäjänä. 

Laitan siis palvelimen päälle (sudo systemctl start apache2) ja kokeilen, mitä tulee kun kirjoitan "curl localhost". Ruudulle tulostuu "Default". Tämä siis tulostuu tiedostosta /var/www/html/index.html, ja varmistan sen vielä komennolla "sudo cat /var/www/html/index.html". 

Olin siis korvannut apachen oletus-index.html-sivun sisällön tekstillä "Default". 

Luen tehtävänantoa kymmenettä kertaa ja kyselen ChatGPT:ltä tyhmiä ja vielä tyhmempiä kysymyksiä, ja alan ehkä vihdoin ymmärtää mitä minun pitäisi tehdä. Pitäisi siis tehdä "etusivu" uusiksi, eli poistaa vanha etusivu ja korvata se hattu.example.com-sivulla niin, että kun menee osoitteeseen "localhost", niin sieltä putkahtaa esiin hattu. Kai.

Löysin sivuston jonka ohjeet näyttävät lupaavilta (ainakin kun selasin ohjeen kahdessa sekunnissa läpi).

Kohdasta Step 2: 
Tehdään hakemistot tai tässä tapauksessa yksi hakemisto, koska sivuja on vain yksi.

sudo mkdir -p /var/www/hattu.example.com/public_html´
Tarkistin ls -komennolla, että kyseinen hakemisto tosiaan on nyt olemassa.
Oliko minun pakko käyttää "sudo mkdir" -komentoa voi olisiko ilman sudoa kelvannut? En tiedä enkä jaksa enää kokeilla. Tai jaksanpa sittenkin. Poistin sekä public_html että hattu.example.com-kansiot.

Loin ne uudelleen ilman sudoa: mkdir -p /var/www/hattu.example.com/public_html
Permission denied.

Palaan nettisivun ohjeisiin. Teen kansion uudelleen sudo-oikeuksilla.

Sitten vaihdan kansion omistajaksi itseni (koska se oli root): 
sudo chown -R $sanna:sanna /var/www/hattu.example.com/public_html

Ohjeessa kehotetaan tekemään myös "suco chmod -R 755 /var/ww mutta en tee sitä, koska ei sivulle pääse mistään ulkopäin.

Sitteen teen yksinkertaisen index.html-sivun 

echo '<html><body><h1>Hattu!</h1></body></html>' |  tee /var/www/hattu.example.com/public_html/index.html

En pysty tekemään ilman sudo-oikeuksia. Muutan itseni public_html-kansion omistajaksi komennolla sudo chown yourusername:yourusername /path/to/directory

Sitten pitäisi mennä tutkimaan sitä virtuaali hostin konfiguraatio-tiedostoa.

Eli sudo micro /etc/apache2/sites-available/hattu.example.com.conf.

Sieltä löytyy edellisen yritykseni DocumentRoot eli /var/www/publicsites/hattu.example.com.

Muutan siihen /var/www/hattu.example.com/public_html

![Add file: Upload](uusidocumentroot.jpg) 

Suoritan komennon "sudo a2ensite hattu.example.com.conf" ja saan ilmoituksen, että Site hattu.example.com already enabled.

Kokeilin onko konfiguraatiotiedoston syntaksi kunnossa komennolla 
sudo apache2ctl configtest

![Add file: Upload](syntaxok.jpg) 

Disabloin oletussivun:

sudo a2dissite 000-default.conf ja sen jälkeen starttasin palvelimen uudelleenn

sudo systemctl reload apache2

Kokeilin nyt komennolla "curl localhost" ja sain tulokseksi "hattu".

![Add file: Upload](localhost.jpg) 

Jos menen selaimella osoitteeseen "localhost", näen siellä tekstin "hattu". Nyt siis näyttäisi olevan niin, että hattu.example.com ja siellä public_html-kansiossa oleva index.html on korvannut apachen oletussivun. En vain ihan ymmärrä, miten se tapahtuu, koska en mielestäni koskenut mihinkään "localhost-juttuun". No mutta, jatketaan eteenpäin.

## e) Tee validi HTML-sivu

Kopsaan sivulta https://terokarvinen.com/2012/short-html5-page/ pohjan sivulle, eli avaan index.html-sivun micro-editorissa

micro /var/www/hattu.example.com/public_html/index.html

![Add file: Upload](html5sivu.jpg) 

Selaimessa:
![Add file: Upload](html5sivu.jpg) 

W3validator valitti yhdestä tagista ja ohjeisti lisäämään kielen.

![Add file: Upload](validator1.jpg) 


Niinpä sitten tein
![Add file: Upload](langlis.jpg) 

Sen jälkeen ei tullut enää mitään varoituksia tai muita ilmoituksia.





